<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anket Analizi - Jolly SmartTour KDS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #2F3A4A;
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-logo {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            object-fit: contain;
            display: block;
            flex-shrink: 0;
        }

        .sidebar-header-text {
            flex: 1;
        }

        .sidebar-header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 12px;
            opacity: 0.9;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background-color: #3A4557;
        }

        .menu-item.active {
            background-color: #3A4557;
            border-left-color: #E30613;
            border-left-width: 4px;
        }

        .menu-item.logout {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 10px;
            padding-top: 20px;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 40px;
            min-height: 100vh;
        }

        .page-title {
            font-size: 32px;
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
        }

        .page-description {
            font-size: 15px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 30px;
            font-weight: 400;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0 0 8px 0;
        }

        .chart-subtitle {
            font-size: 14px;
            color: #666;
            margin: 0 0 25px 0;
        }

        .chart-title-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chart-title-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #3498db;
            color: white;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .chart-loading {
            text-align: center;
            padding: 60px;
            color: #999;
            font-style: italic;
        }

        .chart-error {
            text-align: center;
            padding: 60px;
            color: #e74c3c;
            font-style: normal;
        }

        .chart-insight {
            margin-top: 20px;
            padding: 15px;
            background: #e7f3ff;
            border-left: 4px solid #3498db;
            border-radius: 4px;
            font-size: 14px;
            color: #333;
        }

        .chart-insight.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        /* Heatmap Styles */
        .heatmap-wrapper {
            overflow-x: auto;
            margin-bottom: 15px;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 14px;
            min-width: 500px;
        }

        .heatmap-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: #333;
            border: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .heatmap-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 11;
            background: #f8f9fa !important;
            text-align: left;
            min-width: 100px;
        }

        .heatmap-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #dee2e6;
            position: relative;
            font-weight: 600;
            transition: transform 0.1s;
        }

        .heatmap-table td:hover {
            transform: scale(1.05);
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .heatmap-table td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            background: white !important;
            text-align: left;
            font-weight: 600;
            color: #333;
            min-width: 100px;
        }

        .heatmap-table tbody tr:hover td:first-child {
            background: #f8f9fa !important;
        }

        .heatmap-cell {
            cursor: help;
        }

        .heatmap-legend {
            text-align: center;
            margin-top: 15px;
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        /* Two-column layout for side-by-side charts */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
            align-items: stretch;
        }

        .charts-row .chart-container {
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 1200px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/images/Jolly-Tur-Logo.jpg" alt="Jolly Tur Logo" class="sidebar-logo">
            <div class="sidebar-header-text">
                <h1>Jolly SmartTour</h1>
                <p>Karar Destek Sistemi</p>
            </div>
        </div>
        <nav class="sidebar-menu">
            <a href="home.html" class="menu-item">Anasayfa</a>
            <a href="tour-analysis.html" class="menu-item">Tur Analizi</a>
            <a href="campaign-analysis.html" class="menu-item">Finans ve Kampanya Analizi</a>
            <a href="survey-analysis.html" class="menu-item active">Müşteri ve Anket Analizi</a>
            <a href="login.html" class="menu-item logout">Çıkış Yap</a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <h1 class="page-title">Müşteri ve Anket Analizi</h1>
        <p class="page-description">Bu sayfa, müşteri profili, tercihleri ve kampanya hassasiyetine ilişkin anket verilerini analiz ederek hedef kitleyi daha iyi anlamayı amaçlar.</p>
        
        <!-- Yaş Gruplarına Göre Müşteri Dağılımı and Yaş Grubu × Kampanya Hassasiyeti (Side by Side) -->
        <div class="charts-row">
            <!-- Yaş Gruplarına Göre Müşteri Dağılımı -->
            <div class="chart-container">
                <h2 class="chart-title">Yaş Gruplarına Göre Müşteri Dağılımı</h2>
                <p class="chart-subtitle">Hedef kitle optimizasyonu için yaş aralıklarına göre müşteri dağılımı</p>
                
                <div id="ageChartLoading" class="chart-loading">Yükleniyor...</div>
                <div id="ageChartError" class="chart-error" style="display:none;"></div>
                <div class="chart-wrapper" id="ageChartWrapper" style="display:none;">
                    <canvas id="ageGroupChart"></canvas>
                </div>
                <div id="ageChartInsight" class="chart-insight" style="display:none;"></div>
            </div>

            <!-- Yaş Grubu × Kampanya Hassasiyeti -->
            <div class="chart-container">
                <h2 class="chart-title">Yaş Grubu × Kampanya Hassasiyeti</h2>
                <p class="chart-subtitle">Her yaş grubunda kampanyalı/kampanyasız rezervasyon oranı (%)</p>
                
                <div id="campaignSensitivityLoading" class="chart-loading">Yükleniyor...</div>
                <div id="campaignSensitivityError" class="chart-error" style="display:none;"></div>
                <div class="chart-wrapper" id="campaignSensitivityWrapper" style="display:none;">
                    <canvas id="campaignSensitivityChart"></canvas>
                </div>
                <div id="campaignSensitivityInsight" class="chart-insight" style="display:none;"></div>
            </div>
        </div>

        <!-- Yaş Grubu x Tur Türü Tercihi -->
        <div class="chart-container">
            <h2 class="chart-title">Yaş Grubu x Tur Türü Tercihi</h2>
            <p class="chart-subtitle">Yaş segmentlerinin tur türlerine göre rezervasyon yoğunluğu</p>
            
            <div id="heatmapLoading" class="chart-loading">Yükleniyor...</div>
            <div id="heatmapError" class="chart-error" style="display:none;"></div>
            
            <div id="heatmapContent" style="display:none;">
                <div class="heatmap-wrapper">
                    <table class="heatmap-table" id="heatmapTable">
                        <thead id="heatmapHeader">
                            <tr>
                                <th>Yaş Grubu / Tur Türü</th>
                            </tr>
                        </thead>
                        <tbody id="heatmapBody">
                        </tbody>
                    </table>
                </div>
                <div id="heatmapLegend" class="heatmap-legend"></div>
                <div id="heatmapInsight" class="chart-insight" style="display:none;"></div>
            </div>
        </div>

        <!-- Öncelikli Özellikler and Aktivite Tercihleri (Side by Side) -->
        <div class="charts-row">
            <!-- Öncelikli Özellikler -->
            <div class="chart-container">
                <h2 class="chart-title">Öncelikli Özellikler</h2>
                <p class="chart-subtitle">Müşterilerin tur seçerken en çok önem verdiği kriterler</p>
                
                <div id="priorityFeaturesLoading" class="chart-loading">Yükleniyor...</div>
                <div id="priorityFeaturesError" class="chart-error" style="display:none;"></div>
                <div class="chart-wrapper" id="priorityFeaturesWrapper" style="display:none;">
                    <canvas id="priorityFeaturesChart"></canvas>
                </div>
                <div id="priorityFeaturesInsight" class="chart-insight" style="display:none;"></div>
            </div>

            <!-- Aktivite Tercihleri -->
            <div class="chart-container">
                <h2 class="chart-title">Aktivite Tercihleri</h2>
                <p class="chart-subtitle">Müşterilerin turda en çok tercih ettiği aktiviteler</p>
                
                <div id="activityPreferencesLoading" class="chart-loading">Yükleniyor...</div>
                <div id="activityPreferencesError" class="chart-error" style="display:none;"></div>
                <div class="chart-wrapper" id="activityPreferencesWrapper" style="display:none;">
                    <canvas id="activityPreferencesChart"></canvas>
                </div>
                <div id="activityPreferencesInsight" class="chart-insight" style="display:none;"></div>
            </div>
        </div>

        <!-- Kampanya Etkisi Skoru Dağılımı and Tatil Sıklığı Dağılımı (Side by Side) -->
        <div class="charts-row">
            <!-- Kampanya Etkisi Skoru Dağılımı -->
            <div class="chart-container">
                <div class="chart-title-wrapper">
                    <h2 class="chart-title">Kampanya Etkisi Skoru Dağılımı</h2>
                    <span id="campaignImpactBadge" class="chart-title-badge" style="display:none;"></span>
                </div>
                <p class="chart-subtitle">Müşterilerin kampanya/indirim etkisini algılama segmentleri</p>
                
                <div id="campaignImpactLoading" class="chart-loading">Yükleniyor...</div>
                <div id="campaignImpactError" class="chart-error" style="display:none;"></div>
                <div class="chart-wrapper" id="campaignImpactWrapper" style="display:none;">
                    <canvas id="campaignImpactChart"></canvas>
                </div>
                <div id="campaignImpactInsight" class="chart-insight" style="display:none;"></div>
            </div>

            <!-- Tatil Sıklığı Dağılımı -->
            <div class="chart-container">
                <h2 class="chart-title">Tatil Sıklığı Dağılımı</h2>
                <p class="chart-subtitle">Müşterilerin yılda kaç kez tatile çıktığı</p>
                
                <div id="tatilSikligiLoading" class="chart-loading">Yükleniyor...</div>
                <div id="tatilSikligiError" class="chart-error" style="display:none;"></div>
                <div class="chart-wrapper" id="tatilSikligiWrapper" style="display:none;">
                    <canvas id="tatilSikligiChart"></canvas>
                </div>
                <div id="tatilSikligiInsight" class="chart-insight" style="display:none;"></div>
            </div>
        </div>
    </main>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script>
        // Register datalabels plugin if available
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }
        let ageGroupChart = null;

        async function loadAgeDistribution() {
            const loadingEl = document.getElementById('ageChartLoading');
            const errorEl = document.getElementById('ageChartError');
            const wrapperEl = document.getElementById('ageChartWrapper');
            const insightEl = document.getElementById('ageChartInsight');
            const canvasEl = document.getElementById('ageGroupChart');

            if (!loadingEl || !errorEl || !wrapperEl || !canvasEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                wrapperEl.style.display = 'none';
                insightEl.style.display = 'none';

                const response = await fetch('/api/anket/age-distribution');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.labels || !data.counts || data.counts.length === 0) {
                    throw new Error('Veri bulunamadı');
                }

                loadingEl.style.display = 'none';
                wrapperEl.style.display = 'block';

                // Destroy existing chart if it exists
                if (ageGroupChart) {
                    ageGroupChart.destroy();
                    ageGroupChart = null;
                }

                // Create pie chart
                const ctx = canvasEl.getContext('2d');
                
                // Calculate percentages for labels
                const percentages = data.counts.map(count => {
                    return data.total > 0 ? ((count / data.total) * 100).toFixed(0) : '0';
                });
                
                // Define color mapping for age groups (soft, muted multicolor palette)
                // Each age group has a distinct, harmonious pastel color
                const ageGroupColors = {
                    '18-24': '#A8C5A0',  // Soft sage green (pastel)
                    '25-34': '#9BB5C5',  // Muted dusty blue (pastel)
                    '35-44': '#D4C5B8',  // Light warm beige / sand (pastel)
                    '45-54': '#C5B5D4',  // Soft lavender / muted purple (pastel)
                    '55+': '#B8D4D4'     // Pale teal (pastel)
                };
                
                // Map colors based on label order
                const backgroundColor = data.labels.map(label => {
                    return ageGroupColors[label] || '#E0E0E0'; // Fallback to light grey
                });
                
                ageGroupChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Müşteri Sayısı',
                            data: data.counts,
                            backgroundColor: backgroundColor,
                            borderColor: '#ffffff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 13
                                    },
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed;
                                        const percentage = data.total > 0 
                                            ? ((value / data.total) * 100).toFixed(1) 
                                            : '0.0';
                                        return context.label + ': ' + value + ' müşteri (' + percentage + '%)';
                                    }
                                }
                            },
                            datalabels: {
                                color: '#333',
                                font: {
                                    weight: 'bold',
                                    size: 13
                                },
                                formatter: function(value, context) {
                                    const percentage = data.total > 0 
                                        ? ((value / data.total) * 100).toFixed(0) 
                                        : '0';
                                    return '%' + percentage;
                                },
                                anchor: 'center',
                                align: 'center'
                            }
                        }
                    }
                });

                // Generate dynamic insight text based on age group with highest count
                const maxIndex = data.counts.indexOf(Math.max(...data.counts));
                const maxLabel = data.labels[maxIndex];
                const maxCount = data.counts[maxIndex];
                
                const insightHTML = `En yoğun yaş grubu: ${maxLabel} (${maxCount} müşteri). Pazarlama hedeflemesi bu segmente göre optimize edilebilir.`;

                insightEl.classList.remove('warning');
                insightEl.innerHTML = insightHTML;
                insightEl.style.display = 'block';

            } catch (error) {
                console.error('Yaş dağılımı yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Yaş dağılımı verisi alınamadı.';
                errorEl.style.display = 'block';
            }
        }

        // -----------------------------
        // Age Group × Tour Type Heatmap
        // -----------------------------
        function getHeatmapColor(intensity) {
            // Intensity: 0.0 to 1.0
            // Warm yellow-to-orange color scale - smooth gradient from light yellow to deeper orange
            // Low values: rgb(255, 250, 220) - very light, soft yellow
            // Medium values: muted amber / soft orange (interpolated)
            // High values: rgb(255, 150, 60) - deeper orange (warm, not saturated)
            const r = 255; // Red stays at max for yellow-orange range
            const g = Math.floor(250 - (intensity * 100)); // 250 to 150
            const b = Math.floor(220 - (intensity * 160)); // 220 to 60
            return `rgb(${r}, ${g}, ${b})`;
        }

        function getTextColor(intensity) {
            // Use white text if intensity is high (above 0.7)
            return intensity > 0.7 ? '#ffffff' : '#333333';
        }

        async function loadAgeTourHeatmap() {
            const loadingEl = document.getElementById('heatmapLoading');
            const errorEl = document.getElementById('heatmapError');
            const contentEl = document.getElementById('heatmapContent');
            const headerEl = document.getElementById('heatmapHeader');
            const bodyEl = document.getElementById('heatmapBody');
            const legendEl = document.getElementById('heatmapLegend');
            const insightEl = document.getElementById('heatmapInsight');

            if (!loadingEl || !errorEl || !contentEl || !headerEl || !bodyEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                contentEl.style.display = 'none';
                insightEl.style.display = 'none';

                const response = await fetch('/api/analytics/age-tour-heatmap');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.ageGroups || !data.tourTypes || !data.matrix) {
                    throw new Error('Veri bulunamadı');
                }

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';

                // Build header row
                let headerHTML = '<tr><th>Yaş Grubu / Tur Türü</th>';
                data.tourTypes.forEach(tourType => {
                    headerHTML += `<th>${tourType}</th>`;
                });
                headerHTML += '</tr>';
                headerEl.innerHTML = headerHTML;

                // Build body rows
                let bodyHTML = '';
                const maxValue = data.maxValue || 1; // Prevent division by zero

                data.ageGroups.forEach((ageGroup, ageIndex) => {
                    bodyHTML += `<tr><td>${ageGroup}</td>`;
                    data.tourTypes.forEach((tourType, tourIndex) => {
                        const value = data.matrix[ageIndex] && data.matrix[ageIndex][tourIndex] !== undefined
                            ? data.matrix[ageIndex][tourIndex]
                            : 0;
                        const intensity = maxValue > 0 ? value / maxValue : 0;
                        const bgColor = getHeatmapColor(intensity);
                        const textColor = getTextColor(intensity);
                        
                        bodyHTML += `<td class="heatmap-cell" 
                            style="background-color: ${bgColor}; color: ${textColor};" 
                            title="${ageGroup} • ${tourType}: ${value} rezervasyon">${value}</td>`;
                    });
                    bodyHTML += '</tr>';
                });
                bodyEl.innerHTML = bodyHTML;

                // Update legend (removed)
                legendEl.textContent = '';

                // Generate dynamic insight text based on highest reservation count
                let insightText = '';
                if (data.ageGroups && data.tourTypes && data.matrix && data.matrix.length > 0) {
                    let maxValue = 0;
                    let maxAgeIndex = -1;
                    let maxTourIndex = -1;
                    
                    // Scan all age group × tour type values to find the highest count
                    data.ageGroups.forEach((ageGroup, ageIndex) => {
                        if (data.matrix[ageIndex]) {
                            data.tourTypes.forEach((tourType, tourIndex) => {
                                const value = data.matrix[ageIndex][tourIndex] !== undefined
                                    ? data.matrix[ageIndex][tourIndex]
                                    : 0;
                                if (value > maxValue) {
                                    maxValue = value;
                                    maxAgeIndex = ageIndex;
                                    maxTourIndex = tourIndex;
                                }
                            });
                        }
                    });
                    
                    // Generate insight text if we found a maximum value
                    if (maxAgeIndex >= 0 && maxTourIndex >= 0 && maxValue > 0) {
                        const topAgeGroup = data.ageGroups[maxAgeIndex];
                        const topTourType = data.tourTypes[maxTourIndex];
                        insightText = `En yoğun tercih: ${topAgeGroup} yaş grubu · ${topTourType} (${maxValue} rezervasyon). Bu segment için hedefli kampanya ve içerik planlaması yapılabilir.`;
                    }
                }
                
                if (insightText) {
                    insightEl.innerHTML = insightText;
                    insightEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Isı haritası yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Veri alınamadı.';
                errorEl.style.display = 'block';
            }
        }

        // -----------------------------
        // Age Group × Campaign Sensitivity
        // -----------------------------
        let campaignSensitivityChart = null;

        async function loadCampaignSensitivity() {
            const loadingEl = document.getElementById('campaignSensitivityLoading');
            const errorEl = document.getElementById('campaignSensitivityError');
            const wrapperEl = document.getElementById('campaignSensitivityWrapper');
            const insightEl = document.getElementById('campaignSensitivityInsight');
            const canvasEl = document.getElementById('campaignSensitivityChart');

            if (!loadingEl || !errorEl || !wrapperEl || !canvasEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                wrapperEl.style.display = 'none';
                insightEl.style.display = 'none';

                const response = await fetch('/api/analytics/age-campaign-sensitivity');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.ageGroups || !data.percentages || !data.counts) {
                    throw new Error('Veri bulunamadı');
                }

                loadingEl.style.display = 'none';
                wrapperEl.style.display = 'block';

                // Destroy existing chart if it exists
                if (campaignSensitivityChart) {
                    campaignSensitivityChart.destroy();
                    campaignSensitivityChart = null;
                }

                // Create 100% stacked bar chart
                const ctx = canvasEl.getContext('2d');
                campaignSensitivityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.ageGroups,
                        datasets: [
                            {
                                label: 'Kampanyalı (%)',
                                data: data.percentages['Kampanyalı'],
                                backgroundColor: '#229954',
                                borderColor: '#1e8449',
                                borderWidth: 1
                            },
                            {
                                label: 'Kampanyasız (%)',
                                data: data.percentages['Kampanyasız'],
                                backgroundColor: '#b0bcc0',
                                borderColor: '#95a5a6',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return 'Yaş Grubu: ' + context[0].label;
                                    },
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        const percentage = context.parsed.y.toFixed(2);
                                        const ageIndex = context.dataIndex;
                                        const count = datasetLabel === 'Kampanyalı (%)'
                                            ? data.counts['Kampanyalı'][ageIndex]
                                            : data.counts['Kampanyasız'][ageIndex];
                                        return datasetLabel.replace(' (%)', '') + ': %' + percentage + ' (' + count + ' rezervasyon)';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Yaş Grubu',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                stacked: true,
                                min: 0,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Yüzde (%)',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });

                // Generate dynamic insight text based on age group with highest Kampanyalı percentage
                let insightText = '';
                if (data.ageGroups && data.percentages && data.percentages['Kampanyalı'] && data.percentages['Kampanyalı'].length > 0) {
                    const kampanyaliPercentages = data.percentages['Kampanyalı'];
                    
                    // Find the index with the highest Kampanyalı percentage
                    const maxPercentage = Math.max(...kampanyaliPercentages);
                    const maxIndex = kampanyaliPercentages.indexOf(maxPercentage);
                    const topAgeGroup = data.ageGroups[maxIndex];
                    
                    // Format percentage to show appropriate decimal places
                    const formattedPercentage = maxPercentage.toFixed(1);
                    
                    insightText = `En yüksek kampanya hassasiyeti: ${topAgeGroup} yaş grubu (%${formattedPercentage} kampanyalı). Bu segment için kampanya hedeflemesi artırılabilir.`;
                }
                
                if (insightText) {
                    insightEl.innerHTML = insightText;
                    insightEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Kampanya hassasiyeti yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Kampanya hassasiyeti verisi alınamadı.';
                errorEl.style.display = 'block';
            }
        }

        // -----------------------------
        // Priority Features (Demand Map)
        // -----------------------------
        let priorityFeaturesChart = null;

        async function loadPriorityFeatures() {
            const loadingEl = document.getElementById('priorityFeaturesLoading');
            const errorEl = document.getElementById('priorityFeaturesError');
            const wrapperEl = document.getElementById('priorityFeaturesWrapper');
            const insightEl = document.getElementById('priorityFeaturesInsight');
            const canvasEl = document.getElementById('priorityFeaturesChart');

            if (!loadingEl || !errorEl || !wrapperEl || !canvasEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                wrapperEl.style.display = 'none';
                insightEl.style.display = 'none';

                const response = await fetch('/api/anket/top-oncelikli-ozellikler');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.labels || !data.counts || data.labels.length === 0) {
                    throw new Error('Veri bulunamadı');
                }

                loadingEl.style.display = 'none';
                wrapperEl.style.display = 'block';

                // Destroy existing chart if it exists
                if (priorityFeaturesChart) {
                    priorityFeaturesChart.destroy();
                    priorityFeaturesChart = null;
                }

                // Create horizontal bar chart
                const ctx = canvasEl.getContext('2d');
                priorityFeaturesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Tercih Sayısı',
                            data: data.counts,
                            backgroundColor: '#6988b3',
                            borderColor: '#5a7399',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.x;
                                        const featureName = context.label;
                                        return featureName + ': ' + value + ' yanıt';
                                    }
                                }
                            },
                            datalabels: {
                                color: '#000000',
                                font: {
                                    weight: 600,
                                    size: 14
                                },
                                anchor: 'center',
                                align: 'center',
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Tercih Sayısı',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Öncelikli Özellik',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });

                // Generate dynamic insight text based on top features
                let insightText = '';
                if (data.labels && data.counts && data.counts.length > 0) {
                    // Create array of {label, count} pairs and sort by count (descending)
                    const features = data.labels.map((label, index) => ({
                        label: label,
                        count: data.counts[index]
                    })).sort((a, b) => b.count - a.count);
                    
                    const top1 = features[0];
                    const top2 = features.length > 1 ? features[1] : null;
                    
                    // Check if top 2 features are equal or very close (within 2 counts or 10% difference)
                    const countDifference = top2 ? top1.count - top2.count : top1.count;
                    const percentageDifference = top2 && top1.count > 0 
                        ? (countDifference / top1.count) * 100 
                        : 0;
                    
                    if (top2 && (countDifference <= 2 || percentageDifference <= 10)) {
                        // Top 2 features are close - show both
                        insightText = `${top1.label} ve ${top2.label}, müşteri kararında en belirleyici iki faktördür. Kampanya ve iletişim stratejilerinde bu unsurların önceliklendirilmesi önerilir.`;
                    } else {
                        // Top feature is clearly higher
                        insightText = `Müşteri kararlarında en belirleyici unsur ${top1.label} olarak öne çıkmaktadır. Pazarlama ve paketleme stratejilerinde bu kriterin vurgulanması önerilir.`;
                    }
                }
                
                if (insightText) {
                    insightEl.innerHTML = insightText;
                    insightEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Öncelikli özellikler yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Veri alınamadı.';
                errorEl.style.display = 'block';
            }
        }

        // -----------------------------
        // Activity Preferences
        // -----------------------------
        let activityPreferencesChart = null;

        async function loadActivityPreferences() {
            const loadingEl = document.getElementById('activityPreferencesLoading');
            const errorEl = document.getElementById('activityPreferencesError');
            const wrapperEl = document.getElementById('activityPreferencesWrapper');
            const insightEl = document.getElementById('activityPreferencesInsight');
            const canvasEl = document.getElementById('activityPreferencesChart');

            if (!loadingEl || !errorEl || !wrapperEl || !canvasEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                wrapperEl.style.display = 'none';
                insightEl.style.display = 'none';

                const response = await fetch('/api/anket/aktivite-tercihleri');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.labels || !data.counts || data.labels.length === 0) {
                    loadingEl.style.display = 'none';
                    errorEl.textContent = 'Yeterli veri bulunamadı';
                    errorEl.style.display = 'block';
                    return;
                }

                loadingEl.style.display = 'none';
                wrapperEl.style.display = 'block';

                // Destroy existing chart if it exists
                if (activityPreferencesChart) {
                    activityPreferencesChart.destroy();
                    activityPreferencesChart = null;
                }

                // Create horizontal bar chart
                const ctx = canvasEl.getContext('2d');
                activityPreferencesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Tercih Sayısı',
                            data: data.counts,
                            backgroundColor: '#B8A8C4',
                            borderColor: '#A696B0',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed.x;
                                        return label + ': ' + value + ' yanıt';
                                    }
                                }
                            },
                            datalabels: {
                                color: '#000000',
                                font: {
                                    weight: 600,
                                    size: 14
                                },
                                anchor: 'center',
                                align: 'center',
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Tercih Sayısı',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Aktivite',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });

                // Generate dynamic insight text based on top activities
                let insightText = '';
                if (data.labels && data.counts && data.counts.length > 0) {
                    // Create array of {label, count} pairs and sort by count (descending)
                    const activities = data.labels.map((label, index) => ({
                        label: label,
                        count: data.counts[index]
                    })).sort((a, b) => b.count - a.count);
                    
                    const top1 = activities[0];
                    const top2 = activities.length > 1 ? activities[1] : null;
                    
                    // Check if top 2 activities are close (within 2 counts or 10% difference)
                    const countDifference = top2 ? top1.count - top2.count : top1.count;
                    const percentageDifference = top2 && top1.count > 0 
                        ? (countDifference / top1.count) * 100 
                        : 0;
                    
                    if (top2 && (countDifference <= 2 || percentageDifference <= 10)) {
                        // Top 2 activities are close - show both
                        insightText = `${top1.label} ve ${top2.label}, müşteriler tarafından en çok tercih edilen aktiviteler arasında yer almaktadır. Paket içerikleri bu aktivitelere göre zenginleştirilebilir.`;
                    } else {
                        // Clear top activity
                        insightText = `En çok tercih edilen aktivite: ${top1.label} (${top1.count} tercih). Tur paketlerinde bu aktivitenin öne çıkarılması önerilir.`;
                    }
                }
                
                if (insightText) {
                    insightEl.innerHTML = insightText;
                    insightEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Aktivite tercihleri yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Veri alınamadı.';
                errorEl.style.display = 'block';
            }
        }

        // -----------------------------
        // Campaign Impact Score Distribution
        // -----------------------------
        let campaignImpactChart = null;

        async function loadCampaignImpactDistribution() {
            const loadingEl = document.getElementById('campaignImpactLoading');
            const errorEl = document.getElementById('campaignImpactError');
            const wrapperEl = document.getElementById('campaignImpactWrapper');
            const insightEl = document.getElementById('campaignImpactInsight');
            const badgeEl = document.getElementById('campaignImpactBadge');
            const canvasEl = document.getElementById('campaignImpactChart');

            if (!loadingEl || !errorEl || !wrapperEl || !canvasEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                wrapperEl.style.display = 'none';
                insightEl.style.display = 'none';
                if (badgeEl) badgeEl.style.display = 'none';

                const response = await fetch('/api/anket/kampanya-etkisi-dagilimi');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.segments || data.segments.length === 0 || data.total === 0) {
                    loadingEl.style.display = 'none';
                    errorEl.textContent = 'Veri bulunamadı';
                    errorEl.style.display = 'block';
                    return;
                }

                loadingEl.style.display = 'none';
                wrapperEl.style.display = 'block';

                // Destroy existing chart if it exists
                if (campaignImpactChart) {
                    campaignImpactChart.destroy();
                    campaignImpactChart = null;
                }

                // Update badge with average score
                if (badgeEl && data.avgScore) {
                    badgeEl.textContent = 'Ort. Skor: ' + data.avgScore.toFixed(1);
                    badgeEl.style.display = 'inline-block';
                }

                // Prepare data for normal bar chart (3 bars)
                const labels = data.segments.map(s => s.segment);
                const counts = data.segments.map(s => s.count);
                const colors = ['#E57373', '#F0C674', '#81C784']; // Soft muted red, Neutral yellow-grey, Soft green

                // Create normal bar chart
                const ctx = canvasEl.getContext('2d');
                campaignImpactChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Yanıt Sayısı',
                            data: counts,
                            backgroundColor: colors,
                            borderColor: ['#D32F2F', '#D9B85A', '#66BB6A'], // Slightly darker borders
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Yanıt Sayısı',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Segment',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const count = context.parsed.y;
                                        const total = data.total;
                                        const percent = total > 0 ? ((count / total) * 100).toFixed(2) : '0.00';
                                        return context.label + ': ' + count + ' yanıt (%' + percent + ')';
                                    }
                                }
                            },
                            datalabels: {
                                color: '#000000',
                                font: {
                                    weight: 600,
                                    size: 14
                                },
                                anchor: 'center',
                                align: 'center',
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        }
                    }
                });

                // Generate dynamic insight text based on impact distribution
                let insightText = '';
                if (data.segments && data.segments.length > 0) {
                    // Find counts for each impact level
                    const lowImpact = data.segments.find(s => s.segment.includes('Düşük') || s.segment.includes('0–1'));
                    const mediumImpact = data.segments.find(s => s.segment.includes('Orta') || s.segment.includes('2–3'));
                    const highImpact = data.segments.find(s => s.segment.includes('Yüksek') || s.segment.includes('4–5'));
                    
                    const lowCount = lowImpact ? lowImpact.count : 0;
                    const mediumCount = mediumImpact ? mediumImpact.count : 0;
                    const highCount = highImpact ? highImpact.count : 0;
                    const total = data.total || (lowCount + mediumCount + highCount);
                    
                    // Find the dominant category
                    const maxCount = Math.max(lowCount, mediumCount, highCount);
                    
                    // Determine which category is dominant
                    if (mediumCount === maxCount) {
                        // Medium Impact is highest
                        insightText = 'Kampanya etkisi orta düzeydedir. Bu etki, doğru iletişim ve hedefli kampanyalar ile yüksek etki algısına dönüştürülebilir.';
                    } else if (highCount === maxCount) {
                        // High Impact is highest
                        insightText = 'Kampanya etkisi güçlüdür. Müşterilerin önemli bir bölümü kampanyaları yüksek etkiyle algılamaktadır.';
                    } else if (lowCount === maxCount) {
                        // Low Impact is dominant
                        insightText = 'Kampanya etkisi zayıf algılanmaktadır. Kampanya içeriği ve iletişim dili yeniden gözden geçirilmelidir.';
                    }
                    
                    // Check if Medium + High together clearly dominate Low
                    // "Clearly dominate" means Medium + High is at least 1.5x (or 60%+) of total
                    const mediumHighTotal = mediumCount + highCount;
                    const mediumHighPercentage = total > 0 ? (mediumHighTotal / total) * 100 : 0;
                    const mediumHighDominates = mediumHighTotal > 0 && (mediumHighTotal >= lowCount * 1.5 || mediumHighPercentage >= 60);
                    
                    // Append additional message if Medium + High dominate (and Low is not the dominant category)
                    if (mediumHighDominates && lowCount !== maxCount && insightText) {
                        insightText += ' Genel algı olumlu olmakla birlikte, etki seviyesinin daha da artırılması mümkündür.';
                    }
                }
                
                if (insightText) {
                    insightEl.innerHTML = insightText;
                    insightEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Kampanya etkisi dağılımı yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Veri alınamadı.';
                errorEl.style.display = 'block';
            }
        }

        // Load age distribution, heatmap, campaign sensitivity, priority features, activity preferences, and campaign impact on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAgeDistribution();
            loadAgeTourHeatmap();
            loadCampaignSensitivity();
            loadPriorityFeatures();
            loadActivityPreferences();
            loadCampaignImpactDistribution();
            loadTatilSikligiDistribution();
        });

        // -----------------------------
        // Vacation Frequency Distribution
        // -----------------------------
        let tatilSikligiChart = null;

        async function loadTatilSikligiDistribution() {
            const loadingEl = document.getElementById('tatilSikligiLoading');
            const errorEl = document.getElementById('tatilSikligiError');
            const wrapperEl = document.getElementById('tatilSikligiWrapper');
            const insightEl = document.getElementById('tatilSikligiInsight');
            const canvasEl = document.getElementById('tatilSikligiChart');

            if (!loadingEl || !errorEl || !wrapperEl || !canvasEl) return;

            try {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                wrapperEl.style.display = 'none';
                insightEl.style.display = 'none';

                const response = await fetch('/api/anket/tatil-sikligi-dagilimi');
                if (!response.ok) {
                    throw new Error('API yanıtı alınamadı');
                }

                const data = await response.json();

                if (!data.labels || !data.counts || data.counts.length === 0) {
                    loadingEl.style.display = 'none';
                    errorEl.textContent = 'Veri bulunamadı';
                    errorEl.style.display = 'block';
                    return;
                }

                loadingEl.style.display = 'none';
                wrapperEl.style.display = 'block';

                // Destroy existing chart if it exists
                if (tatilSikligiChart) {
                    tatilSikligiChart.destroy();
                    tatilSikligiChart = null;
                }

                // Create bar chart
                const ctx = canvasEl.getContext('2d');
                tatilSikligiChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Yanıt Sayısı',
                            data: data.counts,
                            backgroundColor: '#6988b3',
                            borderColor: '#5a7399',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.parsed.y + ' yanıt';
                                    }
                                }
                            },
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value > 0) {
                                            ctx.save();
                                            
                                            // Set font properties
                                            ctx.font = '600 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            
                                            // Get text dimensions
                                            const text = String(value);
                                            const textMetrics = ctx.measureText(text);
                                            const textWidth = textMetrics.width;
                                            const textHeight = 14; // Font size
                                            
                                            // Calculate background dimensions with padding
                                            const paddingX = 6;
                                            const paddingY = 4;
                                            const bgWidth = textWidth + (paddingX * 2);
                                            const bgHeight = textHeight + (paddingY * 2);
                                            const borderRadius = 4;
                                            
                                            // Calculate center position within the bar
                                            const barCenterX = element.x;
                                            const barCenterY = element.y + (element.height / 2);
                                            
                                            // Draw rounded rectangle background
                                            ctx.fillStyle = 'rgba(255, 255, 255, 0.65)';
                                            const bgX = barCenterX - (bgWidth / 2);
                                            const bgY = barCenterY - (bgHeight / 2);
                                            ctx.beginPath();
                                            ctx.moveTo(bgX + borderRadius, bgY);
                                            ctx.lineTo(bgX + bgWidth - borderRadius, bgY);
                                            ctx.quadraticCurveTo(bgX + bgWidth, bgY, bgX + bgWidth, bgY + borderRadius);
                                            ctx.lineTo(bgX + bgWidth, bgY + bgHeight - borderRadius);
                                            ctx.quadraticCurveTo(bgX + bgWidth, bgY + bgHeight, bgX + bgWidth - borderRadius, bgY + bgHeight);
                                            ctx.lineTo(bgX + borderRadius, bgY + bgHeight);
                                            ctx.quadraticCurveTo(bgX, bgY + bgHeight, bgX, bgY + bgHeight - borderRadius);
                                            ctx.lineTo(bgX, bgY + borderRadius);
                                            ctx.quadraticCurveTo(bgX, bgY, bgX + borderRadius, bgY);
                                            ctx.closePath();
                                            ctx.fill();
                                            
                                            // Draw text on top
                                            ctx.fillStyle = '#000000';
                                            ctx.fillText(text, barCenterX, barCenterY);
                                            
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        if (Number.isInteger(value)) {
                                            return value;
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Yanıt Sayısı',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Tatil Sıklığı',
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });

                // Update insight text based on dominant category
                let insightText = '';
                if (data.labels && data.counts && data.counts.length > 0) {
                    // Find the index with the highest count
                    const maxCount = Math.max(...data.counts);
                    const dominantIndex = data.counts.indexOf(maxCount);
                    const dominantLabel = data.labels[dominantIndex];
                    
                    // Generate insight text based on dominant category
                    if (dominantLabel === '1' || dominantLabel === '2') {
                        insightText = 'Müşterilerin büyük bölümü yılda 1–2 kez tatile çıkmaktadır. Bu durum, yılda sınırlı sayıda tatil planlayan kitleye yönelik paketlerin önceliklendirilmesi gerektiğini göstermektedir.';
                    } else if (dominantLabel === '3') {
                        insightText = 'Müşterilerin önemli bir kısmı yılda 3 kez tatile çıkmaktadır. Bu segment, daha sık seyahat eden ve kampanyalara duyarlı bir müşteri profiline işaret etmektedir.';
                    } else if (dominantLabel === '4+') {
                        insightText = 'Yılda 4 ve üzeri tatile çıkan müşteri oranının yüksek olması, sadık ve yüksek harcama potansiyeline sahip bir segmenti göstermektedir.';
                    }
                }
                
                if (insightText) {
                    insightEl.innerHTML = insightText;
                    insightEl.style.display = 'block';
                }

            } catch (error) {
                console.error('Tatil sıklığı dağılımı yüklenirken hata:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Veri alınamadı.';
                errorEl.style.display = 'block';
            }
        }
    </script>
</body>
</html>
